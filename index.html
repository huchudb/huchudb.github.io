<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>LTV ê³„ì‚°ê¸° (ì•ˆì •í™” + í…ŒìŠ¤íŠ¸ í¬í•¨)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 960px; margin: 30px auto; padding: 20px; display: flex; gap: 20px; background:#fafafa; }
    h2 { text-align: center; }
    label { font-weight: 700; display:block; margin: 10px 0 6px; }
    select, input, textarea { width:100%; padding:10px; margin-bottom:14px; border:1px solid #ccc; border-radius:8px; font-size:15px; }
    button { width:100%; padding:12px; border:0; border-radius:8px; background:#2c7be5; color:#fff; font-size:16px; cursor:pointer; }
    button:hover { background:#1a5bb8; }
    .result { margin-top:18px; padding:14px; border-radius:10px; background:#f0f8ff; border:1px solid #d0e6ff; }
    small { display:block; margin:-6px 0 12px; color:#555; }
    .calculator { flex:1; }
    .side-design { flex:1; background:url('img/datacenter.jpg') center/cover no-repeat; display:flex; align-items:center; justify-content:center; border-radius:12px; min-height:520px; }
    .side-design img { width:240px; }
    .muted { color:#666; font-size:13px; }
    .warn  { color:#d12; font-size:13px; }
  </style>
</head>
<body>
  <div class="calculator">
    <h2>ğŸ¦ ëŒ€ì¶œ LTV ê³„ì‚°ê¸°</h2>

    <!-- Step 1 -->
    <label>Step 1. ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</label>
    <select id="region">
      <option value="">ì„ íƒí•˜ì„¸ìš”</option>
      <option value="ì„œìš¸">ì„œìš¸</option>
      <option value="ì„œìš¸ ì™¸">ì„œìš¸ ì™¸</option>
    </select>

    <!-- Step 2 -->
    <label>Step 2. ë¶€ë™ì‚° ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</label>
    <select id="propertyType">
      <option value="">ì„ íƒí•˜ì„¸ìš”</option>
      <option value="ì•„íŒŒíŠ¸">ì•„íŒŒíŠ¸</option>
      <option value="ë‹¤ì„¸ëŒ€/ì—°ë¦½">ë‹¤ì„¸ëŒ€/ì—°ë¦½</option>
      <option value="ë‹¨ë…/ë‹¤ê°€êµ¬">ë‹¨ë…/ë‹¤ê°€êµ¬</option>
      <option value="í† ì§€/ì„ì•¼">í† ì§€/ì„ì•¼</option>
    </select>

    <!-- Step 3 -->
    <label>Step 3. ë‚´ê°€ ìƒê°í•˜ëŠ” ì‹œì„¸ (ì›)</label>
    <input type="text" id="marketValue" inputmode="numeric" placeholder="ì˜ˆ: 500,000,000" />
    <small>ì•„íŒŒíŠ¸ëŠ” KBì‹œì„¸(ì¼ë°˜ê°€)ë¥¼ ì…ë ¥í•˜ì„¸ìš” ğŸ‘‰
      <a href="https://onland.kbstar.com/quics?page=C030590" target="_blank" style="color:#2c7be5; text-decoration:underline;">[KBì‹œì„¸ ë°”ë¡œê°€ê¸°]</a>
    </small>

    <!-- Step 4 -->
    <label>Step 4. ì„ ìˆœìœ„ ëŒ€ì¶œ ì›ê¸ˆ + ì„ëŒ€ë³´ì¦ê¸ˆ (ì›)</label>
    <input type="text" id="seniorLoan" inputmode="numeric" placeholder="ì˜ˆ: 100,000,000" />

    <!-- Step 5 -->
    <label>Step 5. í•„ìš”í•œ ëŒ€ì¶œ ê¸ˆì•¡ (ì›)</label>
    <input type="text" id="requestedLoan" inputmode="numeric" placeholder="ì˜ˆ: 50,000,000" />

    <button id="calcBtn">ê³„ì‚°í•˜ê¸°</button>
    <div class="result" id="resultBox" style="display:none;"></div>

    <p class="muted">â€» ê³„ì‚° ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì´ë©° ì‹¤ì œ ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€ëŠ” ê¸ˆìœµê¸°ê´€ ì‹¬ì‚¬ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <p id="emailjsNotice" class="warn" style="display:none;"></p>
  </div>

  <div class="side-design">
    <img src="img/huchu.png" alt="í›„ì¶” ìºë¦­í„°" />
  </div>

  <!-- EmailJS SDK -->
  <script src="https://cdn.emailjs.com/sdk/3.2.0/email.min.js"></script>
  <script>
    /* ===== 1) ìƒìˆ˜ëŠ” ìµœìƒë‹¨ì— ì„ ì–¸: ì´ˆê¸°í™” ìˆœì„œ ë¬¸ì œ ë°©ì§€ ===== */
    const LTV_LIMITS = {
      "ì„œìš¸":     { "ì•„íŒŒíŠ¸": 0.73,   "ë‹¤ì„¸ëŒ€/ì—°ë¦½": 0.70,   "ë‹¨ë…/ë‹¤ê°€êµ¬": 0.70,   "í† ì§€/ì„ì•¼": 0.70   },
      "ì„œìš¸ ì™¸": { "ì•„íŒŒíŠ¸": 0.6998, "ë‹¤ì„¸ëŒ€/ì—°ë¦½": 0.6500, "ë‹¨ë…/ë‹¤ê°€êµ¬": 0.6500, "í† ì§€/ì„ì•¼": 0.4999 }
    };

    // EmailJS ì„¤ì • (ì‚¬ìš©ì ì œê³µ ê°’)
    const EMAILJS_PUBLIC_KEY = "22FTCISS9zfQspQtj";
    const EMAILJS_SERVICE_ID = "huchudb@gmail.com";     // âš ï¸ ë³´í†µ 'service_xxxxx' í˜•íƒœì—¬ì•¼ í•©ë‹ˆë‹¤.
    const EMAILJS_TEMPLATE_ID = "template_v94yxrv";

    /* ===== 2) ìœ í‹¸ ===== */
    const onlyDigits = (s) => (s||"").replace(/[^0-9]/g, "");
    const toNumber  = (s) => Number(onlyDigits(s));
    const fmt       = (n) => isNaN(n) ? "0" : n.toLocaleString();

    function attachCommaFormatter(id){
      const el = document.getElementById(id);
      el.addEventListener('input', () => {
        const raw = onlyDigits(el.value);
        el.value = raw ? Number(raw).toLocaleString() : "";
      });
      el.addEventListener('blur', () => { if(el.value === ',') el.value = ''; });
    }

    document.addEventListener('DOMContentLoaded', () => {
      // EmailJS ì´ˆê¸°í™”
      if (window.emailjs && typeof emailjs.init === 'function') {
        emailjs.init(EMAILJS_PUBLIC_KEY);
      }

      // ì„œë¹„ìŠ¤ ID ìœ íš¨ì„± ì•ˆë‚´
      const notice = document.getElementById('emailjsNotice');
      if (EMAILJS_SERVICE_ID.includes('@')) {
        notice.style.display = 'block';
        notice.textContent = 'EmailJS ì„œë¹„ìŠ¤ IDê°€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤. ë³´í†µ service_xxxxx í˜•íƒœì—¬ì•¼ í•˜ë©°, ì´ë©”ì¼ ì£¼ì†Œë¥¼ ë„£ìœ¼ë©´ ë°œì†¡ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆì–´ìš”. ëŒ€ì‹œë³´ë“œì—ì„œ ì‹¤ì œ Service IDë¡œ êµì²´í•´ ì£¼ì„¸ìš”.';
      }

      // 3ìë¦¬ ì½¤ë§ˆ í¬ë§·í„°
      ['marketValue','seniorLoan','requestedLoan'].forEach(attachCommaFormatter);

      // ê³„ì‚°í•˜ê¸° ë²„íŠ¼
      document.getElementById('calcBtn').addEventListener('click', onCalculate);

      // ê°„ë‹¨ í…ŒìŠ¤íŠ¸ (F12 ì½˜ì†”ì—ì„œ PASS/FAIL í™•ì¸)
      runLtvTests();
    });

    /* ===== 3) ê³„ì‚° ë¡œì§ (ìˆœìˆ˜ í•¨ìˆ˜) ===== */
    function computeLtv({ region, propertyType, marketValue, seniorLoan, requestedLoan }) {
      const ratio = LTV_LIMITS?.[region]?.[propertyType];
      if (typeof ratio !== 'number') throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì§€ì—­/ë¶€ë™ì‚° ì¢…ë¥˜ì…ë‹ˆë‹¤.');
      const maxLoan    = marketValue * ratio;
      const available  = Math.max(0, maxLoan - seniorLoan);
      const currentLtv = marketValue > 0 ? (seniorLoan / marketValue) * 100 : 0;
      const canRequest = requestedLoan ? requestedLoan <= available : null; // null = ë¯¸ì…ë ¥
      return { ratio, maxLoan, available, currentLtv, canRequest };
    }

    /* ===== 4) UI í•¸ë“¤ëŸ¬ ===== */
    function onCalculate(){
      const region        = document.getElementById('region').value;
      const propertyType  = document.getElementById('propertyType').value;
      const marketValue   = toNumber(document.getElementById('marketValue').value);
      const seniorLoan    = toNumber(document.getElementById('seniorLoan').value);
      const requestedLoan = toNumber(document.getElementById('requestedLoan').value);

      if (!region || !propertyType || !marketValue) {
        alert('Step 1~3ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      let stats;
      try {
        stats = computeLtv({ region, propertyType, marketValue, seniorLoan, requestedLoan });
      } catch(e) {
        alert(e.message);
        return;
      }

      const rb = document.getElementById('resultBox');
      rb.style.display = 'block';
      const lines = [
        `<b>ğŸ“Š ê²°ê³¼</b>`,
        `- ì„ íƒí•œ ì§€ì—­: ${region}`,
        `- ë¶€ë™ì‚° ì¢…ë¥˜: ${propertyType}`,
        `- ì‹œì„¸: ${fmt(marketValue)} ì›`,
        `- ì„ ìˆœìœ„ ëŒ€ì¶œ+ë³´ì¦ê¸ˆ: ${fmt(seniorLoan)} ì›`,
        ``,
        `ğŸ‘‰ ì ìš© ìµœëŒ€ LTV: ${(stats.ratio*100).toFixed(0)}%`,
        `ğŸ‘‰ í˜„ì¬ LTV(ì„ ìˆœìœ„ ê¸°ì¤€): ${stats.currentLtv.toFixed(1)}%`,
        `ğŸ‘‰ ì‹ ê·œ ëŒ€ì¶œ ê°€ëŠ¥ ê¸ˆì•¡: ${fmt(stats.available)} ì›`,
      ];

      if (requestedLoan) {
        lines.push(stats.canRequest
          ? `âœ… ìš”ì²­ ê¸ˆì•¡ ${fmt(requestedLoan)}ì› ê°€ëŠ¥`
          : `âŒ ìš”ì²­ ê¸ˆì•¡ ì´ˆê³¼, ìµœëŒ€ ${fmt(stats.available)}ì› ê°€ëŠ¥`);
      }

      rb.innerHTML = lines.join('<br>') + `<br><br><button id="requestBtn">ëŒ€ì¶œ ê¸°ê´€ ì—°ê²° ìš”ì²­í•˜ê¸°</button>`;
      document.getElementById('requestBtn').addEventListener('click', () => showRequestForm(fmt(requestedLoan)));
    }

    function showRequestForm(requestedLoanText){
      const rb = document.getElementById('resultBox');
      rb.innerHTML = `
        <h3>ëŒ€ì¶œ ì—°ê²° ìš”ì²­</h3>
        <label>ì´ë¦„</label><input type="text" id="reqName" placeholder="í™ê¸¸ë™" />
        <label>ì´ë©”ì¼</label><input type="email" id="reqEmail" placeholder="example@domain.com" />
        <label>ì „í™”ë²ˆí˜¸</label><input type="text" id="reqPhone" placeholder="010-1234-5678" />
        <label>ìš”ì²­ ë‚´ìš©</label><textarea id="reqMessage" rows="5">ìš”ì²­ ëŒ€ì¶œ ê¸ˆì•¡: ${requestedLoanText||''}</textarea>
        <button id="sendBtn">ì…ë ¥ ì™„ë£Œ</button>
      `;
      document.getElementById('sendBtn').addEventListener('click', sendRequestEmail);
    }

    function sendRequestEmail(){
      const name    = document.getElementById('reqName').value.trim();
      const email   = document.getElementById('reqEmail').value.trim();
      const phone   = document.getElementById('reqPhone').value.trim();
      const message = document.getElementById('reqMessage').value.trim();

      if (!name || !email || !message) {
        alert('ì´ë¦„/ì´ë©”ì¼/ìš”ì²­ë‚´ìš©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
      }
      if (!window.emailjs) { alert('EmailJS SDK ë¡œë“œ ì‹¤íŒ¨'); return; }

      emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
        from_name:  name,
        from_email: email,
        from_phone: phone,
        message:    message
      }).then(() => {
        alert('ìš”ì²­ì´ ì´ë©”ì¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        location.reload();
      }).catch(err => {
        console.error(err);
        alert('ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: ' + (err?.text || JSON.stringify(err)));
      });
    }

    /* ===== 5) ê°„ë‹¨ í…ŒìŠ¤íŠ¸ (ì½˜ì†”ì—ì„œ í™•ì¸) ===== */
    function runLtvTests(){
      const cases = [
        { name:'ì„œìš¸/ì•„íŒŒíŠ¸ ê°€ëŠ¥',    args:{region:'ì„œìš¸',   propertyType:'ì•„íŒŒíŠ¸',    marketValue:500_000_000, seniorLoan:100_000_000, requestedLoan:200_000_000}, expect:{available:265_000_000, can:true} },
        { name:'ì„œìš¸ ì™¸/ë‹¤ì„¸ëŒ€ ì´ˆê³¼', args:{region:'ì„œìš¸ ì™¸', propertyType:'ë‹¤ì„¸ëŒ€/ì—°ë¦½', marketValue:300_000_000, seniorLoan:150_000_000, requestedLoan: 50_000_000}, expect:{available:45_000_000,  can:false} },
        { name:'ì„œìš¸ ì™¸/í† ì§€ ë¯¸ìš”ì²­', args:{region:'ì„œìš¸ ì™¸', propertyType:'í† ì§€/ì„ì•¼',  marketValue:400_000_000, seniorLoan:100_000_000, requestedLoan: 0}, expect:{available:99_960_000,  can:null} },
      ];
      let passed = 0;
      cases.forEach(tc => {
        try{
          const r = computeLtv(tc.args);
          const okAvail = Math.round(r.available) === Math.round(tc.expect.available);
          const okCan   = r.canRequest === tc.expect.can;
          const ok      = okAvail && okCan;
          console[ok ? 'log' : 'error'](`TEST - ${tc.name}: ${ok ? 'PASS' : 'FAIL'}`);
          if(!ok){ console.error({expected:tc.expect, got:{available:r.available, can:r.canRequest}}); }
          if(ok) passed++;
        }catch(e){ console.error(`TEST - ${tc.name}: EXCEPTION`, e); }
      });
      console.log(`í…ŒìŠ¤íŠ¸ í•©ê²©: ${passed}/${cases.length}`);
    }
  </script>
</body>
</html>
