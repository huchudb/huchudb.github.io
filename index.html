<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>온투업(P2P) 담보대출 계산기</title>

  <!-- 스타일: 한 파일에 통합 -->
  <style>
    :root{
      --primary:#2c7be5; --primary-dark:#1a5bb8; --bg:#f8f9fa; --card:#fff; --muted:#555;
    }
    *{box-sizing:border-box}
    body{font-family:Arial, sans-serif; background:var(--bg); margin:0; padding:24px;}
    .container{max-width:720px; margin:0 auto; background:var(--card); padding:22px; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.08);}
    h1{margin:0 0 8px; font-size:24px;}
    .subtitle{margin:0 0 18px; color:var(--muted); line-height:1.55; font-size:14px;}
    .step{margin:14px 0;}
    label{display:block; font-weight:700; margin-bottom:6px;}
    select,input,textarea{width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:14px;}
    button{width:100%; padding:12px; border:0; border-radius:8px; background:var(--primary); color:#fff; font-size:16px; cursor:pointer;}
    button:hover{background:var(--primary-dark);}
    .info{font-size:12px; color:#666; margin:6px 0 0;}
    .resultBox{margin-top:16px; padding:14px; border-radius:8px; background:#f1f3f5; line-height:1.6;}
    #connectSection{margin-top:18px; padding:16px; border-radius:10px; background:#f7fbff; border:1px solid #d9ecff;}
    #connectSection h2{margin:0 0 12px; font-size:18px;}
    .hide{display:none !important;}
  </style>

  <!-- EmailJS SDK (있으면 사용, 없어도 계산기는 정상 동작) -->
  <script defer src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>온투업(P2P) 담보대출 계산기</h1>
    <p class="subtitle">
      1. 후추DB에 저장된 실제 대출 데이터 기반으로 계산됩니다.<br>
      2. 본 계산기는 신용점수에 전혀 영향이 없습니다.
    </p>

    <!-- STEP 1 -->
    <div class="step">
      <label>STEP1. 지역을 선택해주세요.</label>
      <select id="region">
        <option value="">선택</option>
        <option value="서울">서울</option>
        <option value="서울 외">서울 외</option>
      </select>
    </div>

    <!-- STEP 2 -->
    <div class="step">
      <label>STEP2. 부동산 종류를 선택해주세요.</label>
      <select id="propertyType">
        <option value="">선택</option>
        <option value="아파트">아파트</option>
        <option value="다세대/연립">다세대/연립</option>
        <option value="단독/다가구">단독/다가구</option>
        <option value="기타">기타</option>
      </select>
    </div>

    <!-- STEP 3 -->
    <div class="step">
      <label>STEP3. 내가 생각하는 시세 (원)</label>
      <input type="text" id="marketValue" placeholder="예: 500,000,000">
      <p class="info">
        아파트는 KB시세(일반가)를 입력하세요 →
        <a href="https://kbland.kr" target="_blank">[KB시세 바로가기]</a>
      </p>
    </div>

    <!-- STEP 4 -->
    <div class="step">
      <label>STEP4. 선순위 대출 원금 + 임대보증금 (원)</label>
      <input type="text" id="seniorLoan" placeholder="예: 100,000,000">
    </div>

    <!-- STEP 4-1 -->
    <div class="step">
      <label>STEP4-1. STEP4 금액 중 차감할 금액(대환+보증금반환)</label>
      <input type="text" id="deduction" placeholder="없으면 0 입력" value="0">
    </div>

    <!-- STEP 5 -->
    <div class="step">
      <label>STEP5. 필요한 대출 금액 (원)</label>
      <input type="text" id="requestedLoan" placeholder="예: 50,000,000">
    </div>

    <button id="calcBtn">계산하기</button>
    <div id="result" class="resultBox hide"></div>

    <!-- 대출 기관 연결 요청 -->
    <div id="connectSection" class="hide">
      <h2>대출 기관 연결 요청하기</h2>
      <form id="requestForm">
        <div class="step">
          <label>요청 내용 (자동 기재)</label>
          <textarea id="requestContent" rows="6" readonly></textarea>
        </div>
        <div class="step">
          <label>추가 내용</label>
          <textarea id="extraContent" rows="5" placeholder="대출 기관에서 참고할 만한 사항을 최대한 많이 기재해주세요."></textarea>
        </div>
        <button type="submit">입력 완료</button>
      </form>
    </div>
  </div>

  <!-- 스크립트: 한 파일에 통합 -->
  <script>
    /***** 1) 관리자 설정: 지역/유형별 최대 LTV 비율 *****/
    const LTV_LIMITS = {
      "서울":   { "아파트": 0.73,   "다세대/연립": 0.70,   "단독/다가구": 0.70,   "기타": 0.70 },
      "서울 외":{ "아파트": 0.6998, "다세대/연립": 0.6500, "단독/다가구": 0.6500, "기타": 0.4999 }
    };

    /***** 2) EmailJS 기본값 (있으면 전송, 없어도 계산기 동작) *****/
    const EMAILJS_PUBLIC_KEY  = "22FTCISS9zfQspQtj";
    const EMAILJS_SERVICE_ID  = "service_2fcve4r";
    const EMAILJS_TEMPLATE_ID = "template_v94yxrv";

    function safeInitEmailJS() {
      try {
        if (window.emailjs && typeof emailjs.init === "function") {
          emailjs.init(EMAILJS_PUBLIC_KEY);
          console.log("EmailJS init OK");
        } else {
          console.log("EmailJS SDK not loaded (calculator still works).");
        }
      } catch (e) {
        console.warn("EmailJS init skipped:", e);
      }
    }

    /***** 3) 유틸: 숫자 포맷 *****/
    const onlyDigits = (s) => (s||"").replace(/[^0-9]/g,"");
    const toNumber   = (s) => Number(onlyDigits(s)) || 0;
    const fmt        = (n) => Number.isFinite(n) ? Math.max(0,Math.floor(n)).toLocaleString() : "0";

    function attachComma(id){
      const el = document.getElementById(id);
      el.addEventListener('input', () => {
        const raw = onlyDigits(el.value);
        el.value = raw ? Number(raw).toLocaleString() : "";
      });
    }

    /***** 4) 핵심 계산 로직 *****/
    function computeLtv({region, propertyType, marketValue, seniorLoan, deduction, requestedLoan}) {
      const ratio = LTV_LIMITS?.[region]?.[propertyType];
      if (typeof ratio !== 'number') throw new Error('지역/부동산 종류를 다시 선택해주세요.');

      const effSenior = Math.max(0, seniorLoan - deduction);        // STEP4-1 반영
      const maxLoan   = Math.max(0, marketValue * ratio - effSenior);

      let status; // 'no-request' | 'possible' | 'exceeded'
      if (requestedLoan > 0) {
        status = (requestedLoan <= maxLoan) ? 'possible' : 'exceeded';
      } else {
        status = 'no-request';
      }
      return { ratio, effSenior, maxLoan, status };
    }

    /***** 5) DOM 이벤트 바인딩 *****/
    document.addEventListener('DOMContentLoaded', () => {
      safeInitEmailJS();

      ['marketValue','seniorLoan','deduction','requestedLoan'].forEach(attachComma);
      document.getElementById('calcBtn').addEventListener('click', onCalculate);
      document.getElementById('requestForm').addEventListener('submit', onSend);
    });

    function onCalculate(){
      const region        = document.getElementById('region').value;
      const propertyType  = document.getElementById('propertyType').value;
      const marketValue   = toNumber(document.getElementById('marketValue').value);
      const seniorLoan    = toNumber(document.getElementById('seniorLoan').value);
      const deduction     = toNumber(document.getElementById('deduction').value);
      const requestedLoan = toNumber(document.getElementById('requestedLoan').value);

      if (!region || !propertyType || marketValue <= 0) {
        alert('STEP1~3을 올바르게 입력해주세요.');
        return;
      }

      let r;
      try {
        r = computeLtv({region, propertyType, marketValue, seniorLoan, deduction, requestedLoan});
      } catch(e){
        alert(e.message); return;
      }

      const resultEl  = document.getElementById('result');
      const connectEl = document.getElementById('connectSection');
      resultEl.classList.remove('hide');

      // 결과 문구 (요청: LTV/현재LTV 표시는 제거)
      if (r.status === 'exceeded') {
        resultEl.innerHTML = `❌ <b>LTV 초과, 대출이 불가능합니다.</b>`;
        connectEl.classList.add('hide'); // 5-1 버튼/폼 숨김
        return;
      }

      if (r.status === 'possible') {
        resultEl.innerHTML =
          `✅ 대출 가능<br>` +
          `최대 가능 금액: <b>${fmt(r.maxLoan)} 원</b><br>` +
          `요청 금액: ${fmt(requestedLoan)} 원`;
        connectEl.classList.remove('hide');   // 폼 노출
      } else { // 요청금액 미입력
        resultEl.innerHTML = `최대 가능 금액: <b>${fmt(r.maxLoan)} 원</b>`;
        connectEl.classList.add('hide');      // 폼 숨김
      }

      // 요청 내용 자동기재(계산 내용 그대로)
      const korTypeMap = {"아파트":"아파트","다세대/연립":"다세대/연립","단독/다가구":"단독/다가구","기타":"기타"};
      const lines = [
        "[대출 계산 결과]",
        `지역: ${region}`,
        `부동산 종류: ${korTypeMap[propertyType] || propertyType}`,
        `시세: ${fmt(marketValue)} 원`,
        `선순위: ${fmt(seniorLoan)} 원`,
        `차감금액: ${fmt(deduction)} 원`,
        `실제 반영 선순위: ${fmt(r.effSenior)} 원`,
        `요청금액: ${fmt(requestedLoan)} 원`,
        r.status === 'possible'
          ? `계산결과: 대출 가능 (최대 가능 금액: ${fmt(r.maxLoan)} 원)`
          : `계산결과: 최대 가능 금액은 ${fmt(r.maxLoan)} 원`
      ];
      document.getElementById('requestContent').value = lines.join('\n');
    }

    /***** 6) 이메일 전송 (EmailJS가 없으면 경고만) *****/
    function onSend(e){
      e.preventDefault();
      const request_content = document.getElementById('requestContent').value.trim();
      const extra_content   = document.getElementById('extraContent').value.trim();

      if (!request_content) { alert('요청 내용이 비어 있습니다. 먼저 계산을 진행해주세요.'); return; }

      if (!(window.emailjs && emailjs.send)) {
        alert('현재 이메일 전송 기능을 사용할 수 없습니다. (계산기는 정상 동작)'); return;
      }

      emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
        request_content, extra_content
      }).then(() => {
        alert('요청이 정상적으로 발송되었습니다 ✅');
        document.getElementById('requestForm').reset();
      }).catch(err => {
        console.error(err);
        alert('전송 실패: ' + (err?.text || JSON.stringify(err)));
      });
    }
  </script>
</body>
</html>
